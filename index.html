<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>LIXY Store</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

<style>
    body {
        margin: 0;
        background: #121212;
        font-family: Poppins, sans-serif;
        color: #f2f2f2;
    }

    #splash, #namePage, #brandPage, #productPage, #cartPage {
        display: none;
    }

    .center {
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        text-align: center;
        padding: 20px;
    }

    .logo {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        overflow: hidden;
        margin-bottom: 20px;
        border: 3px solid #fff;
    }
    .logo img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    button {
        padding: 12px 20px;
        background: #39ffb4;
        border: none;
        border-radius: 8px;
        color: #000;
        font-weight: bold;
        cursor: pointer;
        margin-top: 20px;
        transition: 0.2s;
    }
    button:hover { opacity: 0.85; }

    input {
        padding: 12px;
        width: 80%;
        border-radius: 8px;
        border: none;
        margin-top: 10px;
    }

    header {
        padding: 15px 20px;
        background: #1E1E1E;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 50;
    }

    header img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        cursor: pointer;
    }

    /* search bar tetap di atas saat scroll */
    .search-wrap {
        position: sticky;
        top: 70px;
        z-index: 40;
        padding: 10px 12px;
        background: #121212;
        border-bottom: 1px solid #222;
    }

    .search {
        padding: 10px 12px;
        width: 100%;
        border-radius: 10px;
        border: none;
        background: #1f1f1f;
        color: #fff;
        display: block;
        font-size: 15px;
        outline: none;
    }

    /* ===== BRAND PAGE ===== */
    .brand-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
        padding: 20px;
    }

    @media (min-width: 900px) {
        .brand-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }

    .brand-item {
        background: #1F1F1F;
        padding: 14px 18px;
        border-radius: 12px;
        text-align: center;
        color: white;
        font-size: 18px;
        font-weight: 600;
        cursor: pointer;
        border: 1px solid rgba(255,255,255,0.12);
        box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        transition: 0.2s;
    }
    .brand-item:hover {
        background: #292929;
        transform: scale(1.05);
    }

    /* ===== PRODUK LIST VIEW ===== */
    #productList {
        display: grid;
        grid-template-columns: 1fr;
        gap: 15px;
        padding: 10px;
    }
    @media (min-width: 900px) {
        #productList {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    .product-card {
        display: flex;
        background: #111;
        border-radius: 14px;
        padding: 12px;
        color: white;
        align-items: center;
        gap: 12px;
        min-height: 110px;
        box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }

    .product-card img {
        width: 110px;
        height: 110px;
        border-radius: 10px;
        object-fit: cover;
        flex-shrink: 0;
    }

    .product-info {
        display: flex;
        flex-direction: column;
        justify-content: center;
        flex: 1;
    }

    .product-info h3 {
        font-size: 17px;
        margin: 0 0 4px 0;
    }

    .product-info small {
        font-size: 14px;
        opacity: 0.8;
    }

    .add-btn {
        background: #27ffae;
        padding: 6px 12px;
        border-radius: 6px;
        color: black;
        font-weight: bold;
        margin-top: 6px;
        width: fit-content;
        cursor: pointer;
    }

    .badge {
        background: #ff4444;
        padding: 2px 7px;
        border-radius: 50%;
        font-size: 12px;
        position: relative;
        top: -10px;
        right: 10px;
    }

    .cart-item {
        background: #1e1e1e;
        padding: 12px;
        margin: 12px;
        border-radius: 10px;
        display: flex;
        justify-content: space-between;
    }

    .qty-btn {
        padding: 5px 10px;
        background: #39ffb4;
        border-radius: 5px;
        color: black;
        cursor: pointer;
        margin: 0 5px;
        font-weight: bold;
    }

    /* POPUP CHECKOUT */
    #popup {
        display: none;
        position: fixed;
        top: 0; left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        justify-content: center;
        align-items: center;
        padding: 20px;
        z-index: 100;
    }

    #popup .inner {
        background: #1e1e1e;
        padding: 20px;
        border-radius: 12px;
        max-width: 400px;
        width: 100%;
    }

    /* POPUP PILIH OPSI */
    #optionPopup{
        display:none; 
        position:fixed;
        top:0; left:0;
        width:100%; height:100%;
        background:rgba(0,0,0,0.65);
        justify-content:center;
        align-items:center;
        padding:20px;
        z-index: 99;
    }
    #optionPopup .inner-opt{
        background:#1e1e1e;
        padding:20px;
        border-radius:12px;
        max-width:350px;
        width:100%;
        color:white;
    }
    #optionPopup select{
        width:100%;
        padding:10px;
        margin:8px 0;
        border-radius:8px;
        border:none;
        background:#2a2a2a;
        color:white;
        outline:none;
    }
</style>
</head>

<body>

<!-- Splash -->
<div id="splash" class="center">
    <div class="logo"><img src="img/lglixystore.png" alt="LIXY logo"></div>
    <h2>LIXY STORE</h2>
    <button onclick="goName()">Mulai</button>
</div>

<!-- Input Nama -->
<div id="namePage" class="center">
    <h2>Masukkan Nama Kamu</h2>
    <input id="buyerName" placeholder="Nama lengkap">
    <button onclick="saveName()">Lanjut</button>
</div>

<!-- Brand -->
<div id="brandPage">
    <header>
        <img src="img/lglixystore.png" onclick="reloadBrand()" alt="logo">
        <div id="helloUser"></div>
        <div onclick="openCart()" style="cursor:pointer;">
            ðŸ›’ <span id="badge" class="badge" style="display:none;">0</span>
        </div>
    </header>

    <div id="brandList" class="brand-grid">
        <div class="brand-item" onclick="openBrand('fore')">Fore</div>
        <div class="brand-item" onclick="openBrand('kenangan')">Kopi Kenangan</div>
        <div class="brand-item" onclick="openBrand('janjijiwa')">Janji Jiwa</div>
        <div class="brand-item" onclick="openBrand('tomoro')">Tomoro</div>
        <div class="brand-item" onclick="openBrand('chagee')">Chagee</div>
    </div>
</div>

<!-- Produk -->
<div id="productPage">
    <header>
        <img src="img/lglixystore.png" onclick="backBrand()" alt="logo">
        <div id="helloUser2"></div>
        <div onclick="openCart()" style="cursor:pointer;">
            ðŸ›’ <span id="badge2" class="badge" style="display:none;">0</span>
        </div>
    </header>

    <div class="search-wrap">
        <input class="search" placeholder="Cari minuman..." onkeyup="filterProducts(this.value)">
    </div>

    <div id="productList"></div>
</div>

<!-- Cart -->
<div id="cartPage">
    <header>
        <img src="img/lglixystore.png" onclick="backProduct()" alt="logo">
        <div id="helloUser3"></div>
    </header>

    <div id="cartItems"></div>

    <div style="padding:20px;">
        <input id="outletName" placeholder="Outlet mana?" style="width:100%;padding:12px;border-radius:10px;">
        <h3>Total: <span id="totalPrice">Rp 0</span></h3>
        <button onclick="openPopup()">Checkout</button>
    </div>
</div>

<!-- POPUP CHECKOUT -->
<div id="popup">
    <div class="inner">
        <h3>Konfirmasi Pesanan</h3>
        <pre id="popupText" style="white-space: pre-wrap;"></pre>
        <button onclick="sendWA()">Benar</button>
        <button onclick="closePopup()" style="background:#ff4444;">Tidak</button>
    </div>
</div>

<!-- POPUP PILIHAN PRODUK -->
<div id="optionPopup">
    <div class="inner-opt">
        <h3 style="margin-top:0;">Pilih Opsi Minuman</h3>

        <label>Kamu Mau Ice/Hot?:</label>
        <select id="optTemp">
            <option value="Iced">Iced</option>
            <option value="Hot">Hot</option>
        </select>

        <label>Gula:</label>
        <select id="optSugar">
            <option value="Normal">Normal</option>
            <option value="Less Sugar">Less Sugar</option>
        </select>

        <label>Ukuran:</label>
        <select id="optSize">
            <option value="Small">Small</option>
            <option value="Large">Large</option>
        </select>

        <button onclick="confirmOptions()">Tambah ke Keranjang</button>
        <button onclick="closeOptionPopup()" style="background:#ff4444;margin-top:10px;">Batal</button>
    </div>
</div>

<script>
/* --------------- PAGE LOGIC --------------- */
window.onload = () => {
    document.getElementById("splash").style.display = "flex";
};

function goName() {
    splash.style.display = "none";
    namePage.style.display = "flex";
}

function saveName() {
    let name = buyerName.value.trim();
    if (name === "") return alert("Nama tidak boleh kosong");
    localStorage.setItem("buyerName", name);

    helloUser.innerText  = "Belanja Yuk, " + name;
    helloUser2.innerText = "Belanja Yuk, " + name;
    helloUser3.innerText = "Belanja Yuk, " + name;

    namePage.style.display = "none";
    brandPage.style.display = "block";
}

function reloadBrand() {
    productPage.style.display = "none";
    cartPage.style.display    = "none";
    brandPage.style.display   = "block";
}

function backBrand() {
    productPage.style.display = "none";
    brandPage.style.display   = "block";
}

/* --------------- FETCH PRODUCTS (JSON BATCH) --------------- */
let allProducts = [];
let currentBrand = "";


const BRAND_MAP = {
  fore: "data/fore.json",
  kenangan: "data/kenangan.json",
  janjijiwa: "data/janjijiwa.json",
  tomoro: "data/tomoro.json",
  chagee: "data/chagee.json"
};

async function loadBrand(brandKey){
  const cacheKey = "brand_" + brandKey;
  const versionKey = "brandver_" + brandKey;

  // 1) coba ambil data terbaru dari server dulu
  let fresh = null;
  try{
    const res = await fetch(`data/${brandKey}.json?v=${Date.now()}`, {
      cache: "no-store"
    });
    if(!res.ok) throw new Error("fetch failed");
    fresh = await res.json();
  }catch(e){
    fresh = null;
  }

  // 2) kalau server kebaca â†’ cek versi cache
  if(fresh){
    const cachedVersion = parseInt(localStorage.getItem(versionKey) || "0", 10);
    const freshVersion  = parseInt(fresh.version || "1", 10);

    if(freshVersion !== cachedVersion){
      localStorage.setItem(cacheKey, JSON.stringify(fresh));
      localStorage.setItem(versionKey, String(freshVersion));
    }

    currentBrandData = fresh;
    products = fresh.products || [];
    outlets  = fresh.outlets || [];
    renderCategories(products);
    applyFilters();
    return;
  }

  // 3) kalau server gagal â†’ fallback ke cache lokal
  const cached = localStorage.getItem(cacheKey);
  if(cached){
    const data = JSON.parse(cached);
    currentBrandData = data;
    products = data.products || [];
    outlets  = data.outlets || [];
    renderCategories(products);
    applyFilters();
    return;
  }

  // 4) kalau dua-duanya kosong
  products = [];
  outlets = [];
  renderCategories(products);
  applyFilters();
}

async function openBrand(b) {
    currentBrandKey = b;
    brandPage.style.display = "none";
    productPage.style.display = "block";
    await loadBrand(b);
}


function renderProducts(list) {
    const productListEl = document.getElementById("productList");
    productListEl.innerHTML = "";
    list.forEach((p, i) => {
        productListEl.innerHTML += `
            <div class="product-card">
                <img loading="lazy" decoding="async" src="${p.image}" alt="${p.name}">
                <div class="product-info">
                    <h3>${p.name}</h3>
                    <small>Rp ${Number(p.price).toLocaleString()}</small>
                    <div class="add-btn" onclick="addCart(${i})">+ Keranjang</div>
                </div>
            </div>
        `;
    });
}

function filterProducts(q) {
    q = q.toLowerCase();
    let filtered = allProducts.filter(x => x.name.toLowerCase().includes(q));
    renderProducts(filtered);
}

/* --------------- CART + OPTION SYSTEM --------------- */
let cart = [];
let selectedProductIndex = null;

function addCart(i) {
    selectedProductIndex = i;
    openOptionPopup();
}

function openOptionPopup() {
    optionPopup.style.display = "flex";
}

function closeOptionPopup() {
    optionPopup.style.display = "none";
}

function confirmOptions() {
    let temp = document.getElementById("optTemp").value;
    let sugar = document.getElementById("optSugar").value;

    let item = allProducts[selectedProductIndex];

    let exist = cart.find(c =>
        c.name === item.name &&
        c.brand === item.brand &&
        c.temp === temp &&
        c.sugar === sugar
    );

    if (exist) exist.qty++;
    else cart.push({
        ...item,
        qty: 1,
        temp: temp,
        sugar: sugar
    });

    optionPopup.style.display = "none";
    updateBadge();
}

function updateBadge() {
    let qty = cart.reduce((a,b)=>a + b.qty,0);

    if (qty === 0) {
        badge.style.display  = "none";
        badge2.style.display = "none";
    } else {
        badge.innerText  = qty;
        badge2.innerText = qty;
        badge.style.display  = "inline-block";
        badge2.style.display = "inline-block";
    }
}

function openCart() {
    productPage.style.display = "none";
    brandPage.style.display   = "none";
    cartPage.style.display    = "block";
    loadCart();
}

function backProduct() {
    cartPage.style.display    = "none";
    productPage.style.display = "block";
}

function loadCart() {
    const cartItemsEl = document.getElementById("cartItems");
    cartItemsEl.innerHTML = "";
    cart.forEach((c, i) => {
        cartItemsEl.innerHTML += `
            <div class="cart-item">
                <div>
                    <strong>${c.name}</strong><br>
                    <small>${c.temp} â€¢ ${c.sugar}</small><br>
                    Rp ${(c.price * c.qty).toLocaleString()}
                </div>
                <div>
                    <span class="qty-btn" onclick="decQty(${i})">-</span>
                    ${c.qty}
                    <span class="qty-btn" onclick="incQty(${i})">+</span>
                </div>
            </div>
        `;
    });

    updateTotal();
}

function incQty(i){ cart[i].qty++; loadCart(); updateBadge(); }
function decQty(i){
    if (cart[i].qty > 1) cart[i].qty--;
    else cart.splice(i,1);

    loadCart();
    updateBadge();
}

function updateTotal() {
    let total = cart.reduce((a,b)=>a + (b.qty*b.price),0);
    totalPrice.innerText = "Rp " + total.toLocaleString();
}

/* --------------- CHECKOUT --------------- */
function openPopup() {
    let name   = localStorage.getItem("buyerName") || "-";
    let outlet = outletName.value.trim();
    if (outlet === "") return alert("Outlet harus diisi!");

    let listTxt = cart.map(c =>
        `${c.qty}x ${c.name} (${c.temp}, ${c.sugar}) - Rp ${(c.qty*c.price).toLocaleString()}`
    ).join("\n");

    popupText.innerText =
`Nama: ${name}
Outlet: ${outlet}

Pesanan:
${listTxt}`;

    popup.style.display = "flex";
}

function closePopup() {
    popup.style.display = "none";
}

function sendWA() {
    let name   = localStorage.getItem("buyerName") || "-";
    let outlet = outletName.value;

    let listTxt = cart.map(c =>
        `${c.qty}x ${c.name} (${c.temp}, ${c.sugar}) - Rp ${(c.qty*c.price).toLocaleString()}`
    ).join("%0A");

    let msg =
`Nama: ${name}
Outlet: ${outlet}

Pesanan:
${listTxt}`.replace(/\n/g,"%0A");

    window.location.href = `https://wa.me/6281290306599?text=${msg}`;
}
</script>

</body>
</html>

