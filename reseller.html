<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LIXY Store â€“ Premium Minimalist (Reseller)</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#0f0f0f;--bg2:#151515;
  --card:#1c1c1c;--card2:#222;
  --text:#fff;--muted:#bfbfbf;
  --accent:#39ffb4;--accent-dark:#00c985;
  --line:#2a2a2a;--radius:14px;
  --shadow:0 8px 24px rgba(0,0,0,.4);
}
*{box-sizing:border-box;}
body{
  margin:0;background:var(--bg);color:var(--text);
  font-family:Poppins,sans-serif;-webkit-tap-highlight-color:transparent;
}
button{font-family:inherit;cursor:pointer;}
.hidden{display:none!important}

/* Splash */
#splash{
  height:100vh;display:flex;justify-content:center;align-items:center;
  padding:20px;text-align:center;
}
.splash-card{
  background:var(--card);padding:30px 20px;border-radius:20px;
  border:1px solid var(--line);width:min(420px,100%);box-shadow:var(--shadow);
}
.logo{
  width:150px;height:150px;border-radius:50%;overflow:hidden;
  margin:0 auto 16px;border:3px solid #fff;
}
.logo img{width:100%;height:100%;object-fit:cover;}
.btn{
  width:100%;padding:12px;background:var(--accent);border:none;
  border-radius:12px;color:#000;font-weight:800;margin-top:12px;font-size:16px;
}
.btn.secondary{
  background:var(--card2);color:#fff;border:1px solid var(--line);
}
.progress-wrap{
  width:100%;height:8px;background:#0b0b0b;border:1px solid var(--line);
  border-radius:999px;overflow:hidden;margin-top:16px;
}
.progress-bar{
  height:100%;width:0%;
  background:linear-gradient(90deg,var(--accent),var(--accent-dark));
  animation:loadbar 1.8s ease forwards;
}
@keyframes loadbar{to{width:100%;}}

/* Header */
header{
  padding:14px 16px;display:flex;justify-content:space-between;align-items:center;
  position:sticky;top:0;z-index:50;background:rgba(20,20,20,.8);
  backdrop-filter:blur(14px);border-bottom:1px solid var(--line);
}
header img{
  width:42px;height:42px;border-radius:50%;object-fit:cover;
  cursor:pointer;user-select:none;
}
.head-title{font-weight:700;font-size:18px;}
.cart-mini{font-size:18px;cursor:pointer;position:relative;font-weight:700;}
.badge{
  position:absolute;top:-8px;right:-10px;background:#ff4444;color:#fff;
  border-radius:50%;font-size:11px;width:20px;height:20px;
  display:flex;align-items:center;justify-content:center;
  font-weight:800;border:2px solid var(--bg);
}

/* Brand grid */
.brand-grid{
  padding:20px;display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:16px;
}
.brand-item{
  background:var(--card);padding:18px;text-align:center;
  border-radius:var(--radius);border:1px solid var(--line);
  font-weight:700;cursor:pointer;transition:.2s;
}
.brand-item:hover{border-color:var(--accent);transform:translateY(-3px);}

/* Name page */
#namePage{
  min-height:100vh;display:flex;justify-content:center;align-items:center;
  padding:20px;
}

/* Search & chips */
.search-wrap{
  position:sticky;top:70px;z-index:45;background:var(--bg);
  padding:10px 16px;border-bottom:1px solid var(--line);
}
.search{
  width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--line);
  background:var(--card);color:#fff;font-size:15px;
}
.chips{
  display:flex;gap:10px;overflow-x:auto;padding:10px 16px;border-bottom:1px solid var(--line);
}
.chip{
  padding:8px 14px;border-radius:20px;background:var(--card);
  border:1px solid var(--line);font-size:13px;font-weight:600;
  cursor:pointer;white-space:nowrap;
}
.chip.active{background:var(--accent);border-color:var(--accent);color:#000;}

/* Product list */
#productList{
  padding:20px;display:grid;grid-template-columns:1fr;gap:12px;
}
@media(min-width:900px){
  #productList{grid-template-columns:repeat(2,1fr);}
}
.product-card{
  background:var(--card);border-radius:var(--radius);padding:12px;
  border:1px solid var(--line);display:flex;gap:12px;transition:.2s;
}
.product-card:hover{border-color:var(--accent);}
.product-card img{
  width:110px;height:110px;border-radius:12px;object-fit:cover;
  background:#000;flex-shrink:0;
}
.product-info{flex:1;min-width:0;}
.product-info h3{
  margin:0;font-size:16px;font-weight:700;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
}
.product-info small{color:var(--muted);}
.add-btn{
  margin-top:8px;display:inline-block;padding:7px 12px;background:var(--accent);
  color:#000;border-radius:10px;font-weight:800;font-size:13px;
  cursor:pointer;text-align:center;
}

/* Cart */
.cart-item{
  background:var(--card);padding:14px;border-radius:12px;border:1px solid var(--line);
  margin-bottom:12px;display:flex;justify-content:space-between;gap:10px;
}
.qty-btn{
  padding:4px 10px;background:var(--accent);border:none;border-radius:8px;font-weight:700;
}
.remove-btn{
  background:transparent;border:none;color:#ff5555;font-weight:700;cursor:pointer;
}
.summary{padding:16px;}
.summary textarea,.summary input{
  width:100%;background:var(--card);border:1px solid var(--line);
  color:#fff;padding:10px;border-radius:10px;margin-top:8px;
  font-family:inherit;
}

/* Float cart */
#floatCart{
  display:none;position:fixed;left:0;right:0;bottom:0;
  background:rgba(20,20,20,.9);backdrop-filter:blur(10px);
  border-top:1px solid var(--line);padding:10px 14px;z-index:50;
}
.float-inner{
  max-width:1100px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;
}
.float-btn{
  padding:8px 12px;background:var(--accent);border:none;border-radius:10px;
  color:#000;font-weight:800;
}

/* Popup */
#popup{
  display:none;position:fixed;inset:0;background:rgba(0,0,0,.65);
  justify-content:center;align-items:center;padding:20px;z-index:100;
  touch-action: pan-y;
}
#popup .inner{
  background:var(--card2);padding:20px;border-radius:14px;width:min(420px,100%);
  max-height:85vh; overflow:auto; -webkit-overflow-scrolling:touch;
}
#popupText{
  max-height:60vh; overflow:auto; -webkit-overflow-scrolling:touch;
}

/* Option popup */
#optionPopup{
  display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);
  justify-content:center;align-items:center;padding:20px;z-index:120;
}
.inner-opt{
  background:var(--card2);padding:18px;border-radius:14px;width:min(350px,100%);
}
.inner-opt select{
  width:100%;padding:10px;margin:6px 0;border-radius:10px;
  border:1px solid var(--line);background:var(--card);color:#fff;
  font-family:inherit;
}

/* Loading overlay for menu */
#loadingOverlay{
  display:none;position:fixed;inset:0;z-index:200;
  background:rgba(15,15,15,.75);backdrop-filter:blur(6px);
  align-items:center;justify-content:center;flex-direction:column;gap:10px;
}
#loadingOverlay .spinner{
  width:58px;height:58px;border-radius:50%;
  border:4px solid var(--line);border-top-color:var(--accent);
  animation:spin 1s linear infinite;box-shadow:0 0 18px rgba(57,255,180,.35);
}
#loadingOverlay .loading-text{
  color:var(--muted);font-weight:600;font-size:14px;letter-spacing:.3px;
}
@keyframes spin{to{transform:rotate(360deg);}}

/* ===== Custom Outlet Dropdown (Search always visible + selected bold) ===== */
.outlet-box{
  position:relative;
  background:var(--card);
  border:1px solid var(--line);
  border-radius:12px;
  overflow:hidden;
}
.outlet-selected{
  padding:12px 14px;
  font-weight:800;
  cursor:pointer;
  user-select:none;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.outlet-selected span{
  font-weight:600;
  color:var(--muted);
  margin-left:12px;
}
.outlet-panel{
  border-top:1px solid var(--line);
  max-height:260px;
  overflow:auto;
  display:block; /* search & list selalu terlihat */
}
.outlet-search{
  width:100%;
  padding:10px 12px;
  border:none;
  border-bottom:1px solid var(--line);
  outline:none;
  background:var(--bg2);
  color:#fff;
  font-family:inherit;
}
.outlet-item{
  padding:10px 14px;
  cursor:pointer;
}
.outlet-item:hover{
  background:rgba(255,255,255,.06);
}
.outlet-item.active{
  font-weight:800;
  background:rgba(57,255,180,.15);
}
</style>
</head>

<body>

<!-- Splash -->
<section id="splash">
  <div class="splash-card">
    <div class="logo"><img src="img/lglixystore.png" alt="LIXY"></div>
    <h2 style="margin:0;font-size:28px;font-weight:800;">LIXY STORE</h2>
    <p style="color:var(--muted);margin:6px 0 0;">coffee &amp; tea marketplace</p>
    <div class="progress-wrap">
      <div class="progress-bar" id="splashBar"></div>
    </div>
  </div>
</section>

<!-- Name page -->
<section id="namePage" class="hidden">
  <div style="width:min(520px,100%);margin:0 auto;text-align:center;">
    <h2 style="margin:0 0 8px;">Masukkan Nama Kamu</h2>
    <input id="buyerName" class="search" placeholder="Nama lengkap..." maxlength="24">
    <button class="btn" onclick="saveName()">Lanjut</button>
  </div>
</section>

<!-- Brand page -->
<section id="brandPage" class="hidden">
  <header>
    <img src="img/lglixystore.png" alt="logo" onclick="reloadBrand()">
    <div class="head-title" id="helloUser">LIXY Store</div>
    <div class="cart-mini" onclick="openCart()">ðŸ›’ Cart <span id="badge" class="badge hidden">0</span></div>
  </header>

  <div style="padding:0 20px 8px;display:flex;justify-content:flex-end;">
    <button class="btn secondary" style="width:auto;padding:8px 12px;font-size:13px;" onclick="goChangeName()">Ganti Nama</button>
  </div>

  <div style="padding:0 20px;">
    <h2 style="margin:0 0 4px;font-size:20px;">Pilih Brand</h2>
    <p style="margin:0;color:var(--muted);font-size:14px;">Pilih brand favoritmu dulu ya.</p>
  </div>

  <div class="brand-grid">
    <div class="brand-item" onclick="openBrand('fore')">Fore</div>
    <div class="brand-item" onclick="openBrand('kenangan')">Kopi Kenangan</div>
    <div class="brand-item" onclick="openBrand('janjijiwa')">Janji Jiwa</div>
    <div class="brand-item" onclick="openBrand('tomoro')">Tomoro</div>
    <div class="brand-item" onclick="openBrand('chagee')">Chagee</div>
  </div>
</section>

<!-- Product page -->
<section id="productPage" class="hidden">
  <header>
    <img src="img/lglixystore.png" alt="logo" onclick="backBrand()">
    <div class="head-title" id="brandTitle">Produk</div>
    <div class="cart-mini" onclick="openCart()">ðŸ›’ Cart <span id="badge2" class="badge hidden">0</span></div>
  </header>

  <div style="padding:10px 16px;color:var(--muted);font-size:14px;">
    Hi, <span id="helloUser2"></span> ðŸ‘‹
  </div>

  <div class="search-wrap">
    <input id="searchInput" class="search" placeholder="Cari menu..." oninput="onSearch(this.value)">
  </div>

  <div id="categoryChips" class="chips"></div>
  <div id="productList"></div>
</section>

<!-- Cart page -->
<section id="cartPage" class="hidden">
  <header>
    <img src="img/lglixystore.png" alt="logo" onclick="backProduct()">
    <div class="head-title">Keranjang</div>
    <div></div>
  </header>

  <div style="padding:14px 16px 0;">
    <h2 style="margin:0;font-size:18px;">Pesanan Kamu</h2>
    <p style="margin:6px 0 0;color:var(--muted);font-size:14px;">Cek dulu sebelum checkout ya.</p>
  </div>

  <div id="cartItems" style="padding:16px;"></div>

  <div class="summary">
    <label style="font-size:13px;color:var(--muted)">Outlet</label>
    <div id="outletWrapper" style="margin-top:8px;"></div>

    <label style="font-size:13px;color:var(--muted);margin-top:10px;display:block;">Catatan</label>
    <textarea id="cartNotes" rows="3" placeholder="Opsional..."></textarea>

    <h3 style="margin-top:14px;">Total: <span id="totalPrice">Rp 0</span></h3>

    <button class="btn" onclick="openPopup()">Checkout</button>
    <button class="btn secondary" onclick="backProduct()">Tambah Menu</button>
  </div>
</section>

<!-- Float cart -->
<div id="floatCart">
  <div class="float-inner">
    <div>
      <div style="font-size:13px;"><b id="floatCount">0</b> item</div>
      <div style="font-weight:800;" id="floatTotal">Rp 0</div>
    </div>
    <button class="float-btn" onclick="openCart()">Lihat Cart</button>
  </div>
</div>

<!-- Variant popup -->
<div id="optionPopup">
  <div class="inner-opt">
    <h3 id="optTitle" style="margin-top:0;">Pilih Opsi</h3>
    <div id="popupPrice" style="font-size:18px;font-weight:700;margin-top:10px;color:var(--accent);">Rp 0</div>

    <label style="font-size:13px;color:var(--muted);">Ice / Hot</label>
    <select id="optTemp"></select>

    <label style="font-size:13px;color:var(--muted);">Gula</label>
    <select id="optSugar"></select>

    <label style="font-size:13px;color:var(--muted);">Size</label>
    <select id="optSize"></select>

    <button class="btn" onclick="confirmOptions()">Tambah ke Keranjang</button>
    <button class="btn secondary" onclick="closeOptionPopup()">Batal</button>
  </div>
</div>

<!-- Checkout popup -->
<div id="popup">
  <div class="inner">
    <h3>Konfirmasi Pesanan</h3>
    <pre id="popupText" style="white-space:pre-wrap;font-size:14px;"></pre>
    <button class="btn" onclick="sendWA()">Benar</button>
    <button class="btn secondary" onclick="closePopup()" style="border-color:#ff6666;color:#ff6666;margin-top:8px;">Tidak</button>
  </div>
</div>

<!-- Loading overlay -->
<div id="loadingOverlay">
  <div class="spinner"></div>
  <div class="loading-text">Loading menu...</div>
</div>

<script>
// === KONFIG RESELLER ===
const IS_RESELLER = true;      // ubah ke false jika tidak ingin mode reseller
const RESELLER_PLUS = 4000;    // semua harga +4000 di mode reseller

/* =========================
   Utils
========================= */
function rupiah(n){ return "Rp " + Number(n||0).toLocaleString("id-ID"); }
function applyReseller(price){
  return IS_RESELLER ? (Number(price||0) + RESELLER_PLUS) : Number(price||0);
}
function hashJSON(obj){
  try{
    return JSON.stringify(obj).split("").reduce((a,b)=>((a<<5)-a)+b.charCodeAt(0),0);
  }catch(e){ return Math.random(); }
}
function save(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
function load(k,d=null){ const v=localStorage.getItem(k); return v ? JSON.parse(v) : d; }
function showLoading(on){
  const ol=document.getElementById("loadingOverlay");
  if(!ol) return;
  ol.style.display = on ? "flex" : "none";
}

/* =========================
   State
========================= */
let CURRENT_BRAND=null;
let CURRENT_BRAND_DATA=null;
let CURRENT_PRODUCTS=[];
let CURRENT_OUTLETS=[];
let CART=load("cart",[]);
let USERNAME=load("username","");
let LIVE_VERSION=null, LIVE_HASH=null, POLL=null;
let ACTIVE_CATEGORY="All", SEARCH_TEXT="";
let OPT_PRODUCT=null;

/* =========================
   Navigation
========================= */
function saveName(){
  const v=buyerName.value.trim();
  if(!v) return alert("Nama tidak boleh kosong.");
  USERNAME=v; save("username", v);

  namePage.classList.add("hidden");
  brandPage.classList.remove("hidden");
  helloUser.innerText=v;
  helloUser2.innerText=v;
}

function goChangeName(){
  if(POLL) clearInterval(POLL);

  brandPage.classList.add("hidden");
  productPage.classList.add("hidden");
  cartPage.classList.add("hidden");

  namePage.classList.remove("hidden");
  buyerName.value=USERNAME||"";
  buyerName.focus();
}

function reloadBrand(){
  brandPage.classList.remove("hidden");
  productPage.classList.add("hidden");
  cartPage.classList.add("hidden");
  floatCart.style.display="none";
}

function openBrand(key){
  CURRENT_BRAND=key;
  brandPage.classList.add("hidden");
  productPage.classList.remove("hidden");

  helloUser2.innerText=USERNAME;
  brandTitle.innerText=key.toUpperCase();

  loadBrand(key,true);
}

function backBrand(){
  productPage.classList.add("hidden");
  brandPage.classList.remove("hidden");
  floatCart.style.display="none";
}

function openCart(){
  productPage.classList.add("hidden");
  cartPage.classList.remove("hidden");
  renderCart();
}

function backProduct(){
  cartPage.classList.add("hidden");
  productPage.classList.remove("hidden");
}

/* =========================
   Brand JSON
========================= */
async function loadBrand(brand, force=false){
  showLoading(true);
  try{
    // pakai path relatif agar aman di subfolder hosting
    const res = await fetch(`./data/${brand}.json?ts=`+Date.now(), { cache:"no-store" });
    if(!res.ok) throw new Error("HTTP "+res.status);

    const data = await res.json();
    const norm = normalizeBrand(data);
    const v = norm.version || 1;
    const h = hashJSON(norm.products);

    if(force || v!==LIVE_VERSION || h!==LIVE_HASH){
      LIVE_VERSION=v; LIVE_HASH=h;
      CURRENT_BRAND_DATA=norm;
      CURRENT_PRODUCTS=norm.products;
      CURRENT_OUTLETS=norm.outlets || [];

      buildCategories(CURRENT_PRODUCTS);
      renderProducts(CURRENT_PRODUCTS);
    }

    startPolling(brand);
  }catch(e){
    console.error(e);
    productList.innerHTML = `<p style="color:var(--muted);padding:20px;">Gagal memuat menu brand ini.</p>`;
  }finally{
    showLoading(false);
  }
}

function normalizeBrand(d){
  const arr = Array.isArray(d.products) ? d.products : (d.items || []);
  return{
    version:d.version||1,
    brand:d.brand||"",
    outlets: Array.isArray(d.outlets) ? d.outlets : (d.outlets === "manual" ? "manual" : []),
    products: arr.map((p,i)=>({
      id:p.id||("prd-"+i),
      name:p.name||"Unnamed",
      price:Number(p.price)||0,
      image:p.image||"",
      category:p.category||guessCategory(p.name||""),
      variants:p.variants||{
        temperature:["Iced","Hot"],
        sugar:["Normal","Less Sugar"],
        size:["Small","Large"]
      },
      // penting: agar calculateFinalPrice chagee bisa jalan
      variantPricing: p.variantPricing || null
    }))
  };
}

function startPolling(brand){
  if(POLL) clearInterval(POLL);
  POLL = setInterval(()=>loadBrand(brand,false), 20000);
}

function guessCategory(n){
  n=n.toLowerCase();
  if(n.includes("latte")||n.includes("kopi")||n.includes("americano")) return "Coffee";
  if(n.includes("matcha")||n.includes("green")) return "Matcha";
  if(n.includes("tea")) return "Tea";
  if(n.includes("blend")||n.includes("frappe")) return "Frappe";
  if(n.includes("cake")||n.includes("croissant")||n.includes("sandwich")) return "Food";
  return "Other";
}

/* =========================
   Category & search
========================= */
function buildCategories(list){
  const cats=["All",...new Set(list.map(p=>p.category))];
  categoryChips.innerHTML="";
  cats.forEach(cat=>{
    const el=document.createElement("div");
    el.className="chip";
    if(cat==="All") el.classList.add("active");
    el.textContent=cat;
    el.onclick=()=>setCategory(cat);
    categoryChips.appendChild(el);
  });
  ACTIVE_CATEGORY="All";
}
function setCategory(cat){
  ACTIVE_CATEGORY=cat;
  [...categoryChips.children].forEach(c=>c.classList.toggle("active",c.textContent===cat));
  filterAndRender();
}
function onSearch(v){
  SEARCH_TEXT=(v||"").toLowerCase();
  filterAndRender();
}
function filterAndRender(){
  let list=[...CURRENT_PRODUCTS];
  if(ACTIVE_CATEGORY!=="All") list=list.filter(p=>p.category===ACTIVE_CATEGORY);
  if(SEARCH_TEXT) list=list.filter(p=>p.name.toLowerCase().includes(SEARCH_TEXT));
  renderProducts(list);
}

/* =========================
   Render products
========================= */
function renderProducts(list){
  productList.innerHTML="";
  if(list.length===0){
    productList.innerHTML=`<p style="color:var(--muted);padding:20px;">Tidak ada produk.</p>`;
    return;
  }

  list.forEach(p=>{
    const card=document.createElement("div");
    card.className="product-card";

    const img=document.createElement("img");
    img.src=p.image;
    img.onerror=()=>img.src="img/error.png";

    const info=document.createElement("div");
    info.className="product-info";

    const h3=document.createElement("h3");
    h3.textContent=p.name;

    const cat=document.createElement("small");
    cat.textContent=p.category;

    const price=document.createElement("div");
    price.style.marginTop="4px";
    const displayPrice = applyReseller(p.price);
    price.innerHTML=`<b>${rupiah(displayPrice)}</b>`;

    const btn=document.createElement("div");
    btn.className="add-btn";
    btn.textContent="+ Keranjang";
    btn.onclick=()=>openOptionPopup(p);

    info.append(h3,cat,price,btn);
    card.append(img,info);
    productList.appendChild(card);
  });

  updateFloatingCart();
}

/* =========================
   Variant popup + pricing
========================= */
function openOptionPopup(p){
  OPT_PRODUCT=p;

  optTitle.textContent=p.name;
  optTemp.innerHTML=p.variants.temperature.map(v=>`<option>${v}</option>`).join("");
  optSugar.innerHTML=p.variants.sugar.map(v=>`<option>${v}</option>`).join("");
  optSize.innerHTML=p.variants.size.map(v=>`<option>${v}</option>`).join("");

  optSize.onchange=()=>updatePopupPrice();
  setTimeout(updatePopupPrice, 10);

  optionPopup.style.display="flex";
}

function closeOptionPopup(){
  optionPopup.style.display="none";
  OPT_PRODUCT=null;
}

function calculateFinalPrice(product, selectedSize){
  const basePrice = Number(product.price) || 0;

  // CHAGEE: pakai variantPricing jika tersedia
  if(CURRENT_BRAND === "chagee"){
    if(product.variantPricing && product.variantPricing.Size && product.variantPricing.Size[selectedSize]){
      return product.variantPricing.Size[selectedSize];
    }
    return basePrice;
  }

  // Default: Large +5000
  if(selectedSize === "Large") return basePrice + 5000;
  return basePrice;
}

function updatePopupPrice(){
  if(!OPT_PRODUCT || !optSize) return;

  const size = optSize.value;
  let price = calculateFinalPrice(OPT_PRODUCT, size);
  price = applyReseller(price);

  const priceBox=document.getElementById("popupPrice");
  if(priceBox) priceBox.innerText = "Rp " + price.toLocaleString("id-ID");
}

function confirmOptions(){
  if(!OPT_PRODUCT) return;

  const selectedSize = optSize ? optSize.value : "Regular";
  let finalPrice = calculateFinalPrice(OPT_PRODUCT, selectedSize);
  finalPrice = applyReseller(finalPrice);

  const item={
    id: OPT_PRODUCT.id + "-" + Date.now(),
    name: OPT_PRODUCT.name,
    basePrice: OPT_PRODUCT.price,
    finalPrice: finalPrice,
    price: finalPrice,
    size: selectedSize,
    temp: optTemp ? optTemp.value : "",
    sugar: optSugar ? optSugar.value : "",
    image: OPT_PRODUCT.image,
    qty: 1,
    brand: CURRENT_BRAND
  };

  CART.push(item);
  save("cart", CART);

  closeOptionPopup();
  updateBadge();
  updateFloatingCart();
}

/* =========================
   Cart helpers
========================= */
function updateBadge(){
  const count=CART.reduce((a,b)=>a+b.qty,0);
  if(count===0){
    badge.classList.add("hidden");
    badge2.classList.add("hidden");
  }else{
    badge.classList.remove("hidden");
    badge2.classList.remove("hidden");
    badge.textContent=count;
    badge2.textContent=count;
  }
}

function updateFloatingCart(){
  if(CART.length===0){
    floatCart.style.display="none";
    return;
  }
  floatCart.style.display="block";
  floatCount.textContent=CART.reduce((a,b)=>a+b.qty,0);
  floatTotal.textContent=rupiah(CART.reduce((a,b)=>a+b.price*b.qty,0));
}

/* =========================
   Render cart page
========================= */
function renderCart(){
  cartItems.innerHTML="";

  if(CART.length===0){
    cartItems.innerHTML=`<p style='color:var(--muted);padding:12px;'>Keranjang masih kosong.</p>`;
    totalPrice.innerText="Rp 0";
    buildOutletControl();
    return;
  }

  CART.forEach(item=>{
    const row=document.createElement("div");
    row.className="cart-item";
    row.innerHTML=`
      <div style='flex:1;'>
        <b>${item.name}</b><br>
        <small style="color:var(--muted)">${item.temp} â€¢ ${item.sugar} â€¢ ${item.size}</small><br>
        <small>${rupiah(item.price)}</small>
      </div>
      <div style='display:flex;flex-direction:column;align-items:flex-end;'>
        <div>
          <button class='qty-btn' onclick="decQty('${item.id}')">-</button>
          <span style='padding:0 6px;font-weight:700;'>${item.qty}</span>
          <button class='qty-btn' onclick="incQty('${item.id}')">+</button>
        </div>
        <button class='remove-btn' onclick="removeItem('${item.id}')">Hapus</button>
      </div>
    `;
    cartItems.appendChild(row);
  });

  totalPrice.innerText = rupiah(CART.reduce((a,b)=>a+(b.price*b.qty),0));
  buildOutletControl();
}

/* =========================
   Outlet Control (Custom)
   - Search selalu terlihat
   - Aâ€“Z
   - Selected bold + highlight
   - Sumber outlet disimpan di localStorage
========================= */
function buildOutletControl(){
  const wrap=document.getElementById("outletWrapper");
  if(!wrap) return;

  const key = "outlet_" + (CURRENT_BRAND || "default");

  // Manual outlet (input)
  if(CURRENT_OUTLETS === "manual"){
    wrap.innerHTML = `<input id="outletManualInput" class="search" placeholder="Ketik outlet manual...">`;
    const input=document.getElementById("outletManualInput");
    input.value = localStorage.getItem(key) || "";
    input.oninput = (e)=> localStorage.setItem(key, e.target.value || "");
    return;
  }

  // Outlet list (custom dropdown + search)
  if(Array.isArray(CURRENT_OUTLETS) && CURRENT_OUTLETS.length){
    const ALL = [...CURRENT_OUTLETS].sort((a,b)=>
      String(a).localeCompare(String(b), "id", { sensitivity:"base" })
    );

    let selected = localStorage.getItem(key) || ALL[0] || "";
    localStorage.setItem(key, selected);

    wrap.innerHTML = `
      <div class="outlet-box">
        <div class="outlet-selected" id="outletSelected">
          ${selected || "-"} <span>â–¼</span>
        </div>
        <div class="outlet-panel">
          <input id="outletSearch" class="outlet-search" placeholder="Cari outlet...">
          <div id="outletList"></div>
        </div>
      </div>
    `;

    const selectedEl=document.getElementById("outletSelected");
    const searchEl=document.getElementById("outletSearch");
    const listEl=document.getElementById("outletList");

    function render(list){
      listEl.innerHTML="";
      list.forEach(o=>{
        const div=document.createElement("div");
        div.className="outlet-item" + (o===selected ? " active" : "");
        div.textContent=o;
        div.onclick=()=>{
          selected=o;
          localStorage.setItem(key, o);
          selectedEl.innerHTML = `${o} <span>â–¼</span>`;
          render(list);
        };
        listEl.appendChild(div);
      });
    }

    render(ALL);

    searchEl.oninput=()=>{
      const q=(searchEl.value||"").trim().toLowerCase();
      const filtered = !q ? ALL : ALL.filter(o=>String(o).toLowerCase().includes(q));
      render(filtered);
    };

    return;
  }

  // Fallback outlet kosong
  wrap.innerHTML = `<input id="outletFallback" class="search" placeholder="Outlet...">`;
  const fb=document.getElementById("outletFallback");
  fb.value = localStorage.getItem(key) || "";
  fb.oninput = (e)=> localStorage.setItem(key, e.target.value || "");
}

/* =========================
   Cart actions
========================= */
function incQty(id){
  CART=CART.map(x=>{ if(x.id===id) x.qty++; return x; });
  save("cart", CART);
  renderCart(); updateBadge(); updateFloatingCart();
}
function decQty(id){
  CART=CART.map(x=>{ if(x.id===id && x.qty>1) x.qty--; return x; });
  save("cart", CART);
  renderCart(); updateBadge(); updateFloatingCart();
}
function removeItem(id){
  CART=CART.filter(x=>x.id!==id);
  save("cart", CART);
  renderCart(); updateBadge(); updateFloatingCart();
}

/* =========================
   Checkout popup (Outlet dari localStorage)
========================= */
function openPopup(){
  if(CART.length===0) return alert("Keranjang kosong!");
  const name=USERNAME||"";

  const outletKey = "outlet_" + (CURRENT_BRAND || "default");
  const outlet = (localStorage.getItem(outletKey) || "").trim();
  if(!outlet) return alert("Outlet harus diisi.");

  let txt =
    `Pesanan untuk: ${name}\n` +
    `Brand: ${(CURRENT_BRAND_DATA && CURRENT_BRAND_DATA.brand) || CURRENT_BRAND || "-"}\n` +
    `Outlet: ${outlet}\n\n`;

  CART.forEach((it,i)=>{
    txt +=
      `${i+1}. ${it.name}\n` +
      `   ${it.temp} â€¢ ${it.sugar} â€¢ ${it.size}\n` +
      `   Qty: ${it.qty} x ${rupiah(it.price)}\n` +
      `   Total: ${rupiah(it.qty * it.price)}\n\n`;
  });

  const grand=CART.reduce((a,b)=>a+b.price*b.qty,0);
  txt += `Total: ${rupiah(grand)}\n\n`;

  const notes=(cartNotes.value||"").trim();
  if(notes) txt += `Catatan:\n${notes}\n`;

  popupText.textContent=txt;
  popup.style.display="flex";
}

function closePopup(){ popup.style.display="none"; }

function sendWA(){
  const msg=popupText.textContent;
  const nomor="6281294944774"; // nomor WA reseller
  const url="https://wa.me/"+nomor+"?text="+encodeURIComponent(msg);

  window.open(url,"_blank");

  CART=[];
  save("cart", CART);

  closePopup();
  renderCart();
  updateBadge();
  updateFloatingCart();
}

/* =========================
   Init
========================= */
window.addEventListener("load",()=>{
  splash.classList.remove("hidden");
  namePage.classList.add("hidden");
  brandPage.classList.add("hidden");
  productPage.classList.add("hidden");
  cartPage.classList.add("hidden");

  updateBadge();
  updateFloatingCart();

  setTimeout(()=>{
    if(USERNAME){
      splash.classList.add("hidden");
      brandPage.classList.remove("hidden");
      helloUser.textContent=USERNAME;
      helloUser2.textContent=USERNAME;
    }else{
      splash.classList.add("hidden");
      namePage.classList.remove("hidden");
    }
  },1850);
});
</script>

</body>
</html>
